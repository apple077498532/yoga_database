<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‘œä¼½çŸ¥è­˜åº« - ç·¨è¼¯è€…å¾Œå°</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: #f8f9fa; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #6c5ce7; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        input[type="email"], input[type="password"], textarea, select, input[type="number"], input[type="text"] {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;
            font-size: 16px;
        }
        button {
            padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background-color 0.2s;
            color: white; background-color: #0984e3; margin-right: 10px;
        }
        button:hover { background-color: #0c7cd5; }
        .message { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .section { margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ddd; }
        #authInfo { background: #f1f2f6; padding: 15px; border-radius: 8px; font-size: 14px; }
        #authStatus { margin-bottom: 20px; }
        /* èª¿æ•´ radio button é¡¯ç¤º */
        #flowSelection label { margin-right: 20px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ§˜â€â™€ï¸ ç·¨è¼¯è€…å…§å®¹ç®¡ç† (MVP)</h1>
    
    <div id="authStatus">
        <p id="authMessage">è«‹å…ˆç™»å…¥æˆ–è¨»å†Šã€‚</p>
        <div id="authInfo" style="display: none;"></div>
    </div>

    <div id="authSection" class="section">
        <h2>ç™»å…¥ / è¨»å†Š</h2>
        <div class="form-group">
            <input type="email" id="authEmail" placeholder="é›»å­éƒµä»¶" required>
        </div>
        <div class="form-group">
            <input type="password" id="authPassword" placeholder="å¯†ç¢¼" required>
        </div>
        <button onclick="signUp()">è¨»å†Š</button>
        <button onclick="signIn()">ç™»å…¥</button>
    </div>

    <div id="flowSelection" class="section" style="display: none;">
        <h2>é¸æ“‡æ“ä½œæ¨¡å¼</h2>
        <div class="form-group">
            <input type="radio" id="flowNew" name="adminFlow" value="new" onclick="switchView('new')" checked>
            <label for="flowNew">âŠ æ–°å¢é«”å¼ + å£ä»¤ (æ–°é«”å¼)</label>
            
            <input type="radio" id="flowExisting" name="adminFlow" value="existing" onclick="switchView('existing')">
            <label for="flowExisting">â‹ ç·¨è¼¯å£ä»¤ (ç¾æœ‰é«”å¼)</label>
        </div>
        <hr style="border: 1px dashed #eee; margin: 10px 0;">
    </div>


    <div id="poseAddSection" class="section" style="display: none;">
        <h2>ğŸ“ æ–°å¢é«”å¼ (Pose) åŠé¦–æ¢å£ä»¤</h2>
        <div class="form-group">
            <label for="newPoseNameZh">ä¸­æ–‡åç¨± (e.g., å¹»æ¤…å¼):</label>
            <input type="text" id="newPoseNameZh" required>
        </div>
        
        <div class="form-group" style="display: none;">
            <label for="newPoseNameEn">è‹±æ–‡åç¨± (e.g., Chair Pose):</label>
            <input type="text" id="newPoseNameEn"> 
        </div>

        <div class="form-group">
            <label for="newPoseCategory">åˆ†é¡ (e.g., ç«™å§¿):</label>
            <input type="text" id="newPoseCategory" list="categoryOptions" required>
            <datalist id="categoryOptions"></datalist> 
        </div>
        
        <div class="form-group">
            <label for="initialCueType">é¦–æ¢å£ä»¤é¡å‹:</label>
            <select id="initialCueType" required>
                <option value="entry">é€²å…¥é«”å¼ (entry)</option>
                <option value="action">å‹•ä½œç²¾ä¿® (action)</option>
                <option value="safety">å®‰å…¨æé†’ (safety)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="initialCueContent">é¦–æ¢å£ä»¤å…§å®¹ (é †åº 1):</label>
            <textarea id="initialCueContent" rows="2" placeholder="ä¾‹å¦‚: é›™æ‰‹æ¨åœ°ï¼Œåéª¨å‘å¾Œå‘ä¸Šå»¶ä¼¸..." required></textarea>
        </div>

        <button onclick="submitNewPose()">æäº¤æ–°é«”å¼ + é¦–æ¢å£ä»¤</button>
        <div id="poseMessage" class="message" style="display: none;"></div>
    </div>

    <div id="cueSection" class="section" style="display: none;">
        <h2>ğŸ“ ç·¨è¼¯å£ä»¤ (ç¾æœ‰é«”å¼æ–°å¢)</h2>
        <div class="form-group">
            <label for="poseSelect">é¸æ“‡é«”å¼:</label>
            <select id="poseSelect" required></select>
        </div>
        <div class="form-group">
            <label for="cueType">å£ä»¤é¡å‹:</label>
            <select id="cueType" required>
                <option value="entry">é€²å…¥é«”å¼ (entry)</option>
                <option value="action">å‹•ä½œç²¾ä¿® (action)</option>
                <option value="safety">å®‰å…¨æé†’ (safety)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="cueContent">å£ä»¤å…§å®¹:</label>
            <textarea id="cueContent" rows="3" placeholder="ä¾‹å¦‚: é›™æ‰‹æ¨åœ°ï¼Œåéª¨å‘å¾Œå‘ä¸Šå»¶ä¼¸..." required></textarea>
        </div>
        <div class="form-group">
            <label for="cueSequence">é †åº (æ•¸å­—):</label>
            <input type="number" id="cueSequence" value="2" min="1" required>
        </div>
        <button onclick="submitCue()">æäº¤å£ä»¤</button>
        <div id="cueMessage" class="message" style="display: none;"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // =======================================================
    // 1. SUPABASE è¨­å®š (è«‹æª¢æŸ¥é‡‘é‘°æ˜¯å¦æ­£ç¢º)
    // =======================================================
    const SUPABASE_URL = 'https://webmekskpvfmiwzycuam.supabase.co'; 
    const SUPABASE_ANON_KEY = 'sb_publishable_aiSsE7UnC4DNZPaTvIx23A_x-0Nk8mu'; 
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        db: { schema: 'public' },
    });
    
    let poseList = []; 

    // =======================================================
    // 2. èªè­‰åŠŸèƒ½ (Auth)
    // =======================================================

    async function signUp() {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        showAuthMessage('è¨»å†Šä¸­...');

        if (password.length < 6) {
             showAuthMessage('è¨»å†Šå¤±æ•—ï¼šå¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—ç¬¦', 'error');
             return;
        }

        const { data, error } = await supabase.auth.signUp({ email, password });

        if (error) {
            showAuthMessage('è¨»å†Šå¤±æ•—ï¼š' + error.message, 'error');
            return;
        }

        showAuthMessage('è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥é›»å­éƒµä»¶ï¼Œç„¶å¾Œé»æ“Šã€Œç™»å…¥ã€', 'success');
        
        if (data.user) {
            await insertNewUserToPublicTable(data.user.id, email);
        }
    }

    async function insertNewUserToPublicTable(uid, email) {
        const { error } = await supabase
            .from('Users')
            .insert({ 
                id: uid, 
                email: email, 
                display_name: email.split('@')[0] + ' è€å¸«',
                role: 'editor' 
            });

        if (error) {
             console.error('Failed to insert user into public.Users:', error);
        }
    }


    async function signIn() {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        showAuthMessage('ç™»å…¥ä¸­...');

        const { data, error } = await supabase.auth.signInWithPassword({ email, password });

        if (error) {
            showAuthMessage('ç™»å…¥å¤±æ•—ï¼š' + error.message, 'error');
            return;
        }

        // RLS ç¹é/ä¿®æ­£ï¼šå¼·åˆ¶åˆ·æ–° Token
        if (data.user) {
            const { error: updateError } = await supabase.auth.updateUser({
                data: { last_login: new Date().toISOString() }
            });
            if (updateError) console.error("Error refreshing JWT:", updateError);
        }
        
        checkAuthStatus();
    }

    async function signOut() {
        showAuthMessage('ç™»å‡ºä¸­...');
        const { error } = await supabase.auth.signOut();
        if (error) {
             showAuthMessage('ç™»å‡ºå¤±æ•—ï¼š' + error.message, 'error');
             return;
        }
        checkAuthStatus();
    }


    async function checkAuthStatus() {
        const { data: { user } } = await supabase.auth.getUser();
        const authMessage = document.getElementById('authMessage');
        const authInfo = document.getElementById('authInfo');
        const authSection = document.getElementById('authSection');
        const flowSelection = document.getElementById('flowSelection');
        
        if (user) {
            authSection.style.display = 'none';
            flowSelection.style.display = 'block';

            // é è¨­é¸æ“‡æ–°å¢é«”å¼æ¨¡å¼ (æ–°æµç¨‹)
            document.getElementById('flowNew').checked = true;
            switchView('new');
            
            const { data: userData, error: userError } = await supabase
                .from('Users')
                .select('display_name, role')
                .eq('id', user.id)
                .single();

            if (userError) {
                 authMessage.innerHTML = 'âœ… ç™»å…¥æˆåŠŸï¼ä½†ç„¡æ³•è®€å–æ‚¨çš„è§’è‰²è³‡è¨Šã€‚';
                 authInfo.style.display = 'block';
                 authInfo.innerHTML = `
                     <p><strong>å¸³è™Ÿ:</strong> ${user.email}</p>
                     <p><strong>âš ï¸ ç„¡æ³•å–å¾—è§’è‰²ã€‚</strong></p>
                     <button onclick="signOut()">ç™»å‡º</button>
                 `;
                 return;
            }
            
            authMessage.innerHTML = `âœ… ç™»å…¥æˆåŠŸï¼æ­¡è¿æ‚¨ï¼Œ${userData.display_name}ï¼`;
            authInfo.style.display = 'block';
            authInfo.innerHTML = `
                <p><strong>å¸³è™Ÿ:</strong> ${user.email}</p>
                <p><strong>æ¬Šé™è§’è‰²:</strong> ${userData.role}</p>
                <button onclick="signOut()">ç™»å‡º</button>
            `;
            
            loadCategoryOptions(); // è¼‰å…¥åˆ†é¡é¸é …
            loadPosesForSelection(); // è¼‰å…¥é«”å¼åˆ—è¡¨

        } else {
            authMessage.innerHTML = 'è«‹å…ˆç™»å…¥æˆ–è¨»å†Šã€‚';
            authSection.style.display = 'block';
            flowSelection.style.display = 'none';
            document.getElementById('poseAddSection').style.display = 'none'; 
            document.getElementById('cueSection').style.display = 'none'; 
            authInfo.style.display = 'none';
        }
    }

    // NEW: æµç¨‹åˆ‡æ›åŠŸèƒ½
    function switchView(mode) {
        const poseAdd = document.getElementById('poseAddSection');
        const cueAdd = document.getElementById('cueSection');
        
        if (mode === 'new') {
            poseAdd.style.display = 'block';
            cueAdd.style.display = 'none';
            showPoseMessage('è«‹å…ˆæäº¤æ–°çš„é«”å¼è¨˜éŒ„ã€‚', 'info');
        } else if (mode === 'existing') {
            poseAdd.style.display = 'none';
            cueAdd.style.display = 'block';
            showCueMessage('è«‹é¸æ“‡ç¾æœ‰é«”å¼ä¸¦æ–°å¢å£ä»¤ã€‚', 'info');
        }
    }
    
    // =======================================================
    // 3. å…§å®¹ç®¡ç†åŠŸèƒ½ (Cues)
    // =======================================================

    // è¼‰å…¥åˆ†é¡é¸é …ï¼Œç”¨æ–¼è‡ªå‹•å®Œæˆ
    async function loadCategoryOptions() {
        const { data, error } = await supabase
            .from('Poses')
            .select('category')
            .not('category', 'is', null); 

        if (error) {
            console.error("Error loading categories:", error);
            return;
        }

        const uniqueCategories = [...new Set(data.map(item => item.category.trim()))].filter(Boolean);
        
        const datalist = document.getElementById('categoryOptions');
        datalist.innerHTML = ''; 
        
        uniqueCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            datalist.appendChild(option);
        });
    }


    async function loadPosesForSelection() {
        // è®€å– Poses åˆ—è¡¨
        const { data, error } = await supabase
            .from('Poses')
            .select('id, name_zh')
            .order('name_zh', { ascending: true });

        if (error) {
            showCueMessage('ç„¡æ³•è¼‰å…¥é«”å¼åˆ—è¡¨ï¼š' + error.message, 'error');
            return;
        }

        poseList = data;
        const select = document.getElementById('poseSelect');
        select.innerHTML = '';
        
        poseList.forEach(pose => {
            const option = document.createElement('option');
            option.value = pose.id;
            // åªé¡¯ç¤ºä¸­æ–‡åç¨±
            option.textContent = pose.name_zh; 
            select.appendChild(option);
        });
        
        showCueMessage('', 'success');
    }

    async function submitCue() {
        const pose_id = document.getElementById('poseSelect').value;
        const content = document.getElementById('cueContent').value.trim();
        const type = document.getElementById('cueType').value;
        const sequence = parseInt(document.getElementById('cueSequence').value);
        
        if (!content || isNaN(sequence)) {
            showCueMessage('è«‹å¡«å¯«å®Œæ•´çš„å£ä»¤å…§å®¹å’Œé †åº', 'error');
            return;
        }

        const user = (await supabase.auth.getUser()).data.user;
        if (!user) {
            showCueMessage('ç™»å…¥ç‹€æ…‹éºå¤±ï¼Œè«‹é‡æ–°ç™»å…¥', 'error');
            return;
        }
        
        // æäº¤ INSERT è«‹æ±‚
        const { error } = await supabase
            .from('Cues')
            .insert({
                pose_id: pose_id,
                content: content,
                type: type,
                sequence: sequence,
                created_by: user.id
            });
            
        if (error) {
            showCueMessage('æäº¤å¤±æ•—ï¼š' + error.message + ' (è«‹æª¢æŸ¥ Cues è¡¨ RLS)', 'error');
        } else {
            showCueMessage('å£ä»¤æäº¤æˆåŠŸï¼è«‹åˆ·æ–°ä¸»ç¶²ç«™æŸ¥çœ‹ã€‚', 'success');
            document.getElementById('cueContent').value = ''; 
            document.getElementById('cueSequence').value = sequence + 1; 
        }
    }

    // =======================================================
    // 4. æ–°å¢é«”å¼åŠŸèƒ½ (Poses) - å–®æ¬¡æäº¤é«”å¼èˆ‡é¦–æ¢å£ä»¤
    // =======================================================
    async function submitNewPose() {
        const name_zh = document.getElementById('newPoseNameZh').value.trim();
        // è‹±æ–‡åç¨±æ¬„ä½å·²éš±è—ï¼Œå‚³è¼¸ç©ºå­—ä¸²
        const name_en = document.getElementById('newPoseNameEn').value.trim() || ''; 
        const category = document.getElementById('newPoseCategory').value.trim();
        
        // NEW CUE INPUTS:
        const cueContent = document.getElementById('initialCueContent').value.trim();
        const cueType = document.getElementById('initialCueType').value;

        // ä¿®æ­£æª¢æŸ¥ï¼šé«”å¼åç¨±ã€åˆ†é¡ã€é¦–æ¢å£ä»¤éƒ½ä¸èƒ½ç‚ºç©º
        if (!name_zh || !category || !cueContent) {
            showPoseMessage('è«‹å¡«å¯«é«”å¼ä¸­æ–‡åç¨±ã€åˆ†é¡å’Œé¦–æ¢å£ä»¤å…§å®¹ï¼', 'error');
            return;
        }

        const user = (await supabase.auth.getUser()).data.user;
        if (!user) {
            showPoseMessage('ç™»å…¥ç‹€æ…‹éºå¤±ï¼Œè«‹é‡æ–°ç™»å…¥', 'error');
            return;
        }

        showPoseMessage('æäº¤ä¸­...', 'info');

        // --- STEP 1: æäº¤æ–°é«”å¼åˆ° Poses è¡¨ (å¿…é ˆè¿”å›æ–° ID) ---
        const { data: newPoseData, error: poseError } = await supabase
            .from('Poses')
            .insert({
                name_zh: name_zh,
                name_en: name_en,
                category: category,
                updated_by: user.id 
            })
            .select('id') // è«‹æ±‚è¿”å›æ–°å»ºç«‹çš„è³‡æ–™çš„ ID
            .single();

        if (poseError) {
            showPoseMessage('é«”å¼æäº¤å¤±æ•—ï¼š' + poseError.message + ' (è«‹æª¢æŸ¥ Poses è¡¨ RLS)', 'error');
            return;
        }
        
        const newPoseId = newPoseData.id;

        // --- STEP 2: æäº¤é¦–æ¢å£ä»¤åˆ° Cues è¡¨ ---
        const { error: cueError } = await supabase
            .from('Cues')
            .insert({
                pose_id: newPoseId, 
                content: cueContent,
                type: cueType,
                sequence: 1, // è¨­ç‚ºé †åº 1
                created_by: user.id
            });
                
        if (cueError) {
            showPoseMessage('é«”å¼å‰µå»ºæˆåŠŸï¼Œä½†å£ä»¤æäº¤å¤±æ•—ï¼š' + cueError.message + ' (è«‹æª¢æŸ¥ Cues è¡¨ RLS)', 'error');
            return;
        }

        // --- STEP 3: æˆåŠŸä¸¦æ¸…ç† ---
        showPoseMessage(`é«”å¼ "${name_zh}" åŠé¦–æ¢å£ä»¤æäº¤æˆåŠŸï¼`, 'success');
        
        // æ¸…ç©ºè¡¨å–®ä¸¦åˆ·æ–°åˆ—è¡¨
        document.getElementById('newPoseNameZh').value = '';
        document.getElementById('newPoseNameEn').value = '';
        document.getElementById('newPoseCategory').value = '';
        document.getElementById('initialCueContent').value = '';
        
        loadCategoryOptions(); 
        loadPosesForSelection(); 
        document.getElementById('flowExisting').checked = true;
        switchView('existing'); // è‡ªå‹•åˆ‡æ›åˆ°æ–°å¢å£ä»¤æ¨¡å¼ (æ–¹ä¾¿è€å¸«ç¹¼çºŒæ–°å¢ç¬¬2/3æ¢å£ä»¤)
    }

    function showPoseMessage(message, type = 'info') {
        const poseMessage = document.getElementById('poseMessage');
        poseMessage.innerHTML = message;
        poseMessage.className = `message ${type}`;
        poseMessage.style.display = 'block';
    }


    // =======================================================
    // 5. è¼”åŠ©å‡½å¼ (ä¿æŒä¸è®Š)
    // =======================================================
    
    function showAuthMessage(message, type = 'info') {
        const authMessage = document.getElementById('authMessage');
        authMessage.innerHTML = message;
        authMessage.className = `message ${type}`;
    }

    function showCueMessage(message, type = 'info') {
        const cueMessage = document.getElementById('cueMessage');
        cueMessage.innerHTML = message;
        cueMessage.className = `message ${type}`;
        cueMessage.style.display = 'block';
    }

    // åˆå§‹åŒ–æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    window.onload = checkAuthStatus;

</script>
</body>
</html>
