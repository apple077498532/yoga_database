<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç‘œä¼½çŸ¥è­˜åº« - ç·¨è¼¯è€…å¾Œå°</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: #f8f9fa; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        h1 { color: #6c5ce7; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .form-group { margin-bottom: 15px; }
        input[type="email"], input[type="password"], textarea, select, input[type="number"], input[type="text"] {
            width: 100%; padding: 12px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box;
            font-size: 16px;
        }
        button {
            padding: 10px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: background-color 0.2s;
            color: white; background-color: #0984e3; margin-right: 10px;
        }
        button:hover { background-color: #0c7cd5; }
        .message { margin-top: 20px; padding: 15px; border-radius: 8px; font-weight: bold; }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        .section { margin-top: 30px; padding-top: 20px; border-top: 1px dashed #ddd; }
        #authInfo { background: #f1f2f6; padding: 15px; border-radius: 8px; font-size: 14px; }
        #authStatus { margin-bottom: 20px; }
    </style>
</head>
<body>

<div class="container">
    <h1>ğŸ§˜â€â™€ï¸ ç·¨è¼¯è€…å…§å®¹ç®¡ç† (MVP)</h1>
    
    <div id="authStatus">
        <p id="authMessage">è«‹å…ˆç™»å…¥æˆ–è¨»å†Šã€‚</p>
        <div id="authInfo" style="display: none;"></div>
    </div>

    <div id="authSection" class="section">
        <h2>ç™»å…¥ / è¨»å†Š</h2>
        <div class="form-group">
            <input type="email" id="authEmail" placeholder="é›»å­éƒµä»¶" required>
        </div>
        <div class="form-group">
            <input type="password" id="authPassword" placeholder="å¯†ç¢¼" required>
        </div>
        <button onclick="signUp()">è¨»å†Š</button>
        <button onclick="signIn()">ç™»å…¥</button>
    </div>

    <div id="poseAddSection" class="section" style="display: none;">
        <h2>â• æ–°å¢é«”å¼ (Pose)</h2>
        <div class="form-group">
            <label for="newPoseNameZh">ä¸­æ–‡åç¨± (e.g., å¹»æ¤…å¼):</label>
            <input type="text" id="newPoseNameZh" required>
        </div>
        <div class="form-group">
            <label for="newPoseNameEn">è‹±æ–‡åç¨± (e.g., Chair Pose):</label>
            <input type="text" id="newPoseNameEn" required>
        </div>
        <div class="form-group">
            <label for="newPoseCategory">åˆ†é¡ (e.g., ç«™å§¿):</label>
            <input type="text" id="newPoseCategory" list="categoryOptions" required>
            <datalist id="categoryOptions"></datalist> 
        </div>
        <button onclick="submitNewPose()">æäº¤æ–°é«”å¼</button>
        <div id="poseMessage" class="message" style="display: none;"></div>
    </div>

    <hr style="border: 1px solid #ddd; margin: 40px 0;">

    <div id="cueSection" class="section" style="display: none;">
        <h2>ğŸ“ æ–°å¢æ•™å­¸å£ä»¤ (Cues)</h2>
        <div class="form-group">
            <label for="poseSelect">é¸æ“‡é«”å¼:</label>
            <select id="poseSelect" required></select>
        </div>
        <div class="form-group">
            <label for="cueType">å£ä»¤é¡å‹:</label>
            <select id="cueType" required>
                <option value="entry">é€²å…¥é«”å¼ (entry)</option>
                <option value="action">å‹•ä½œç²¾ä¿® (action)</option>
                <option value="safety">å®‰å…¨æé†’ (safety)</option>
            </select>
        </div>
        <div class="form-group">
            <label for="cueContent">å£ä»¤å…§å®¹:</label>
            <textarea id="cueContent" rows="3" placeholder="ä¾‹å¦‚: é›™æ‰‹æ¨åœ°ï¼Œåéª¨å‘å¾Œå‘ä¸Šå»¶ä¼¸..." required></textarea>
        </div>
        <div class="form-group">
            <label for="cueSequence">é †åº (æ•¸å­—):</label>
            <input type="number" id="cueSequence" value="1" min="1" required>
        </div>
        <button onclick="submitCue()">æäº¤å£ä»¤</button>
        <div id="cueMessage" class="message" style="display: none;"></div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // =======================================================
    // 1. SUPABASE è¨­å®š (è«‹æª¢æŸ¥é‡‘é‘°æ˜¯å¦æ­£ç¢º)
    // =======================================================
    const SUPABASE_URL = 'https://webmekskpvfmiwzycuam.supabase.co'; 
    const SUPABASE_ANON_KEY = 'sb_publishable_aiSsE7UnC4DNZPaTvIx23A_x-0Nk8mu'; 
    
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
        db: { schema: 'public' },
    });
    
    let poseList = []; 

    // =======================================================
    // 2. èªè­‰åŠŸèƒ½ (Auth)
    // =======================================================

    async function signUp() {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        showAuthMessage('è¨»å†Šä¸­...');

        if (password.length < 6) {
             showAuthMessage('è¨»å†Šå¤±æ•—ï¼šå¯†ç¢¼é•·åº¦è‡³å°‘éœ€è¦ 6 å€‹å­—ç¬¦', 'error');
             return;
        }

        const { data, error } = await supabase.auth.signUp({ email, password });

        if (error) {
            showAuthMessage('è¨»å†Šå¤±æ•—ï¼š' + error.message, 'error');
            return;
        }

        showAuthMessage('è¨»å†ŠæˆåŠŸï¼è«‹æª¢æŸ¥é›»å­éƒµä»¶ï¼Œç„¶å¾Œé»æ“Šã€Œç™»å…¥ã€', 'success');
        
        if (data.user) {
            await insertNewUserToPublicTable(data.user.id, email);
        }
    }

    async function insertNewUserToPublicTable(uid, email) {
        const { error } = await supabase
            .from('Users')
            .insert({ 
                id: uid, 
                email: email, 
                display_name: email.split('@')[0] + ' è€å¸«',
                role: 'editor' 
            });

        if (error) {
             console.error('Failed to insert user into public.Users:', error);
        }
    }


    async function signIn() {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        showAuthMessage('ç™»å…¥ä¸­...');

        const { data, error } = await supabase.auth.signInWithPassword({ email, password });

        if (error) {
            showAuthMessage('ç™»å…¥å¤±æ•—ï¼š' + error.message, 'error');
            return;
        }

        checkAuthStatus();
    }

    async function signOut() {
        showAuthMessage('ç™»å‡ºä¸­...');
        const { error } = await supabase.auth.signOut();
        if (error) {
             showAuthMessage('ç™»å‡ºå¤±æ•—ï¼š' + error.message, 'error');
             return;
        }
        checkAuthStatus();
    }


    async function checkAuthStatus() {
        const { data: { user } } = await supabase.auth.getUser();
        const authMessage = document.getElementById('authMessage');
        const authInfo = document.getElementById('authInfo');
        const authSection = document.getElementById('authSection');
        const cueSection = document.getElementById('cueSection');
        const poseAddSection = document.getElementById('poseAddSection');

        
        if (user) {
            authSection.style.display = 'none';
            cueSection.style.display = 'block';
            poseAddSection.style.display = 'block'; 
            
            const { data: userData, error: userError } = await supabase
                .from('Users')
                .select('display_name, role')
                .eq('id', user.id)
                .single();

            if (userError) {
                 authMessage.innerHTML = 'âœ… ç™»å…¥æˆåŠŸï¼ä½†ç„¡æ³•è®€å–æ‚¨çš„è§’è‰²è³‡è¨Šã€‚';
                 authInfo.style.display = 'block';
                 authInfo.innerHTML = `
                     <p><strong>å¸³è™Ÿ:</strong> ${user.email}</p>
                     <p><strong>âš ï¸ ç„¡æ³•å–å¾—è§’è‰²ã€‚</strong></p>
                     <button onclick="signOut()">ç™»å‡º</button>
                 `;
                 return;
            }
            
            authMessage.innerHTML = `âœ… ç™»å…¥æˆåŠŸï¼æ­¡è¿æ‚¨ï¼Œ${userData.display_name}ï¼`;
            authInfo.style.display = 'block';
            authInfo.innerHTML = `
                <p><strong>å¸³è™Ÿ:</strong> ${user.email}</p>
                <p><strong>æ¬Šé™è§’è‰²:</strong> ${userData.role}</p>
                <button onclick="signOut()">ç™»å‡º</button>
            `;
            
            loadCategoryOptions(); // NEW: å…ˆè¼‰å…¥åˆ†é¡é¸é …
            loadPosesForSelection(); // è¼‰å…¥é«”å¼åˆ—è¡¨

        } else {
            authMessage.innerHTML = 'è«‹å…ˆç™»å…¥æˆ–è¨»å†Šã€‚';
            authSection.style.display = 'block';
            cueSection.style.display = 'none';
            poseAddSection.style.display = 'none'; 
            authInfo.style.display = 'none';
        }
    }
    
    // =======================================================
    // 3. å…§å®¹ç®¡ç†åŠŸèƒ½ (Cues)
    // =======================================================

    // NEW: è¼‰å…¥åˆ†é¡é¸é …ï¼Œç”¨æ–¼è‡ªå‹•å®Œæˆ
    async function loadCategoryOptions() {
        const { data, error } = await supabase
            .from('Poses')
            .select('category')
            .not('category', 'is', null); 

        if (error) {
            console.error("Error loading categories:", error);
            return;
        }

        // æå–æ‰€æœ‰ä¸é‡è¤‡çš„åˆ†é¡åç¨±
        const uniqueCategories = [...new Set(data.map(item => item.category.trim()))].filter(Boolean);
        
        const datalist = document.getElementById('categoryOptions');
        datalist.innerHTML = ''; 
        
        uniqueCategories.forEach(category => {
            const option = document.createElement('option');
            option.value = category;
            datalist.appendChild(option);
        });
    }


    async function loadPosesForSelection() {
        // è®€å– Poses åˆ—è¡¨
        const { data, error } = await supabase
            .from('Poses')
            .select('id, name_zh')
            .order('name_zh', { ascending: true });

        if (error) {
            showCueMessage('ç„¡æ³•è¼‰å…¥é«”å¼åˆ—è¡¨ï¼š' + error.message, 'error');
            return;
        }

        poseList = data;
        const select = document.getElementById('poseSelect');
        select.innerHTML = '';
        
        poseList.forEach(pose => {
            const option = document.createElement('option');
            option.value = pose.id;
            // é€™è£¡åªé¡¯ç¤ºä¸­æ–‡åç¨±
            option.textContent = pose.name_zh; 
            select.appendChild(option);
        });
        
        showCueMessage('', 'success');
    }

    async function submitCue() {
        const pose_id = document.getElementById('poseSelect').value;
        const content = document.getElementById('cueContent').value.trim();
        const type = document.getElementById('cueType').value;
        const sequence = parseInt(document.getElementById('cueSequence').value);
        
        if (!content || isNaN(sequence)) {
            showCueMessage('è«‹å¡«å¯«å®Œæ•´çš„å£ä»¤å…§å®¹å’Œé †åº', 'error');
            return;
        }

        const user = (await supabase.auth.getUser()).data.user;
        if (!user) {
            showCueMessage('ç™»å…¥ç‹€æ…‹éºå¤±ï¼Œè«‹é‡æ–°ç™»å…¥', 'error');
            return;
        }
        
        // æäº¤ INSERT è«‹æ±‚
        const { error } = await supabase
            .from('Cues')
            .insert({
                pose_id: pose_id,
                content: content,
                type: type,
                sequence: sequence,
                created_by: user.id
            });
            
        if (error) {
            showCueMessage('æäº¤å¤±æ•—ï¼š' + error.message + ' (è«‹æª¢æŸ¥æ‚¨çš„ RLS æ¬Šé™)', 'error');
        } else {
            showCueMessage('å£ä»¤æäº¤æˆåŠŸï¼è«‹åˆ·æ–°ä¸»ç¶²ç«™æŸ¥çœ‹ã€‚', 'success');
            document.getElementById('cueContent').value = ''; 
            document.getElementById('cueSequence').value = sequence + 1; 
        }
    }

    // =======================================================
    // 4. æ–°å¢é«”å¼åŠŸèƒ½ (Poses)
    // =======================================================
    async function submitNewPose() {
        const name_zh = document.getElementById('newPoseNameZh').value.trim();
        const name_en = document.getElementById('newPoseNameEn').value.trim();
        const category = document.getElementById('newPoseCategory').value.trim();

        if (!name_zh || !name_en || !category) {
            showPoseMessage('è«‹å¡«å¯«æ‰€æœ‰é«”å¼æ¬„ä½ï¼', 'error');
            return;
        }

        const user = (await supabase.auth.getUser()).data.user;
        if (!user) {
            showPoseMessage('ç™»å…¥ç‹€æ…‹éºå¤±ï¼Œè«‹é‡æ–°ç™»å…¥', 'error');
            return;
        }

        showPoseMessage('æäº¤ä¸­...', 'info');

        // æäº¤ INSERT è«‹æ±‚åˆ° Poses è¡¨
        const { error } = await supabase
            .from('Poses')
            .insert({
                name_zh: name_zh,
                name_en: name_en,
                category: category,
                updated_by: user.id 
            });

        if (error) {
            showPoseMessage('é«”å¼æäº¤å¤±æ•—ï¼š' + error.message + ' (è«‹æª¢æŸ¥ Poses è¡¨ RLS)', 'error');
        } else {
            showPoseMessage(`é«”å¼ "${name_zh}" æäº¤æˆåŠŸï¼`, 'success');
            
            // æ¸…ç©ºè¡¨å–®
            document.getElementById('newPoseNameZh').value = '';
            document.getElementById('newPoseNameEn').value = '';
            document.getElementById('newPoseCategory').value = '';
            
            // åˆ·æ–°åˆ†é¡å’Œé«”å¼åˆ—è¡¨
            loadCategoryOptions(); 
            loadPosesForSelection(); 
        }
    }

    function showPoseMessage(message, type = 'info') {
        const poseMessage = document.getElementById('poseMessage');
        poseMessage.innerHTML = message;
        poseMessage.className = `message ${type}`;
        poseMessage.style.display = 'block';
    }


    // =======================================================
    // 5. è¼”åŠ©å‡½å¼ (ä¿æŒä¸è®Š)
    // =======================================================
    
    function showAuthMessage(message, type = 'info') {
        const authMessage = document.getElementById('authMessage');
        authMessage.innerHTML = message;
        authMessage.className = `message ${type}`;
    }

    function showCueMessage(message, type = 'info') {
        const cueMessage = document.getElementById('cueMessage');
        cueMessage.innerHTML = message;
        cueMessage.className = `message ${type}`;
        cueMessage.style.display = 'block';
    }

    // åˆå§‹åŒ–æ™‚æª¢æŸ¥ç™»å…¥ç‹€æ…‹
    window.onload = checkAuthStatus;

</script>
</body>
</html>
